#include "unit_test_support.h"
#include "acos_sounding_id.h"
#include "oco_sounding_id.h"
#include "acos_ecmwf.h"
#include "oco_met_file.h"

using namespace FullPhysics;
using namespace blitz;
BOOST_FIXTURE_TEST_SUITE(met_acos, GlobalFixture)

BOOST_AUTO_TEST_CASE(ecmwf)
{
  std::string sid = "20091009203401";
  HdfFile sfile(test_data_dir() + "in/sounding_id.h5");
  std::vector<boost::shared_ptr<HdfSoundingId> > sidv = 
    AcosSoundingId::create(sfile, sid);
  AcosEcmwf e(test_data_dir() + "in/ecmwf.h5", sidv[0], sidv.size() > 1);
  BOOST_CHECK_CLOSE(e.surface_pressure(), 99682.828125, 1e-6);
  Array<double, 1> press(20);
  press = 100, 7000, 10000, 20000, 28000, 35000, 40000, 45000,
    50000, 55000, 60000, 65000, 70000, 75000, 80000, 85000, 90000, 95000,
    100000, 105000;
  Array<double, 1> texpect(20);
  texpect =
    243.90097378304642461, 214.55495206293338128, 218.03548301856420721,
    222.54439025512246531, 218.33300494385892421, 221.37919630741211563,
    227.3962815102570687,
    233.51051500723281151, 239.38876092919977623, 244.52113267396558172,
    248.71471551251292453, 251.98636348202509794, 254.54141229243495559,
    256.65775880671048981, 
    258.52334065260964735, 260.15648388783131395, 261.74845655310156189,
    261.7317782935307946, 256.31781429833779384, 257.36699412179075352;
  BOOST_CHECK_MATRIX_CLOSE(e.temperature(press), texpect);
  Array<double, 1> vmr_expect(20);
  vmr_expect = 
    6.52915085338131434138e-06, 4.74802211086569229482e-06, 4.92840307027326174783e-06,
    7.14068695346565009954e-06, 3.06465709946443932554e-05, 7.57551402530849389647e-05,
    1.16493281320304099065e-04, 1.35521593385681674623e-04, 1.83875983083302410115e-04,
    2.64376164629756744452e-04, 3.68792169005680763125e-04, 4.65498603629904477916e-04,
    5.48674415316505658877e-04, 5.73115442420909929414e-04, 6.15337784112228577613e-04,
    7.40936275682209898041e-04, 9.08908284989747017324e-04, 1.30631957917109933071e-03,
    1.41811951670399731713e-03, 1.55141541137329805507e-03;
  BOOST_CHECK_MATRIX_CLOSE(e.vmr("H2O", press), vmr_expect);
}

BOOST_AUTO_TEST_SUITE_END()

BOOST_FIXTURE_TEST_SUITE(met_oco, GlobalFixture)

BOOST_AUTO_TEST_CASE(ecmwf)
{
  std::string sid = "2010090900133574";
  HdfFile sfile(test_data_dir() + "/oco2_ECMWFND_80008a_111018214952d_spliced.h5");
  boost::shared_ptr<HdfSoundingId> sido(new OcoSoundingId(sfile, sid));
  OcoMetFile e(test_data_dir() + "/oco2_ECMWFND_80008a_111018214952d_spliced.h5", sido);
  BOOST_CHECK_CLOSE(e.surface_pressure(), 95796, 1e-6);
  BOOST_CHECK_CLOSE(e.windspeed(), 9.5288243675028176938, 1e-6);
  Array<double, 1> press(20);
  press = 100, 7000, 10000, 20000, 28000, 35000, 40000, 45000,
    50000, 55000, 60000, 65000, 70000, 75000, 80000, 85000, 90000, 95000,
    100000, 105000;
  Array<double, 1> texpect(20);
  texpect =
    249.99932014712481987, 204.71691671141664415, 205.14682181545998674,
    206.67900774692736832, 211.72013798983311972, 218.03120044161263991,
    222.97529589441276698, 227.78345303636547214, 233.27363833074147692,
    238.46076429718232248, 242.14518070680597361, 245.05993612140508731,
    248.07973362637457626, 251.15477955996385617, 253.2607227236587164,
    253.89281922755003507, 249.47060311981078939, 253.32026131834302873,
    257.52964972931016518, 261.61106752656741037;
  BOOST_CHECK_MATRIX_CLOSE(e.temperature(press), texpect);
  Array<double, 1> vmr_expect(20);
  vmr_expect = 
    6.18463363909663014530e-06, 2.36965266390393393926e-06, 1.79124472076385485451e-06,
    4.44939716759828362880e-06, 4.26638117666292847238e-06, 2.31053455225090924774e-05,
    4.30666795274530419808e-05, 8.04953920753194977376e-05, 1.28253250001733338365e-04,
    1.19399307731459902292e-04, 1.31142344697486427658e-04, 1.98203458381546247617e-04,
    5.08592865304613645817e-04, 6.00716039185911080192e-04, 4.91739179804330539016e-04,
    4.30433305414070366962e-04, 7.85226390760217999448e-04, 1.02408279413748835168e-03,
    1.49869481155999960918e-03, 2.19762296775938021504e-03;

  BOOST_CHECK_MATRIX_CLOSE(e.vmr("H2O", press), vmr_expect);
}

BOOST_AUTO_TEST_CASE(geos5)
{
  std::string sid = "2015070100333531";
  HdfFile sfile(test_data_dir() + "/oco2_L2MetGL_05297a_150701_Bxxxx_170127155155d_spliced.h5");
  boost::shared_ptr<HdfSoundingId> sido(new OcoSoundingId(sfile, sid));
  OcoMetFile e(test_data_dir() + "/oco2_L2MetGL_05297a_150701_Bxxxx_170127155155d_spliced.h5", sido);
  BOOST_CHECK_CLOSE(e.surface_pressure(), 96871.289, 1e-6);
  BOOST_CHECK_CLOSE(e.windspeed(), 8.428493579942538, 1e-6);
  Array<double, 1> press(20);
  press = 100, 7000, 10000, 20000, 28000, 35000, 40000, 45000,
    50000, 55000, 60000, 65000, 70000, 75000, 80000, 85000, 90000, 95000,
    100000, 105000;
  Array<double, 1> texpect(20);
  texpect =
      230.5346396005774352, 218.60047801197865169, 220.64412804746820029, 
      223.16561002844196082, 219.26148179720536291, 222.40556675538212517, 
      228.34629129485082899, 234.70629521425851749, 242.32803370589996916, 
      248.75573227792187936, 253.50945760168744414, 257.45739991023572202, 
      260.72271454883457409, 264.43200731469079301, 267.96359689836515372, 
      271.38280941891349585, 274.01680236144864011, 276.9505894260992136, 
      280.98359546819432353, 284.87427687730797743;
  BOOST_CHECK_MATRIX_CLOSE(e.temperature(press), texpect);
  Array<double, 1> vmr_expect(20);
  vmr_expect = 
      6.32858778109025421605e-06, 4.69937319817151636958e-06, 4.70072557676363511452e-06,
      1.03786999947082847403e-05, 1.43230675337823501166e-05, 4.05647993230577822029e-05,
      1.47489513146525105889e-04, 3.35148700732445549433e-04, 6.95477941722260403073e-04,
      1.20923427018879365083e-03, 1.74569623879772869296e-03, 2.29547574694992850483e-03,
      2.57661651668930537923e-03, 2.94160816596165941572e-03, 3.69432736254865588116e-03,
      5.33150511708435463631e-03, 7.13869769764232959403e-03, 8.11776571828678322751e-03,
      9.11614312203354142106e-03, 1.01795237014713577800e-02;

  BOOST_CHECK_MATRIX_CLOSE(e.vmr("H2O", press), vmr_expect);
}

BOOST_AUTO_TEST_SUITE_END()
